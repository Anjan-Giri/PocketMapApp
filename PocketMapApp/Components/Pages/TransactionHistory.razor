@page "/transactionHistory"
@using PocketMapApp.Services
@using PocketMapApp.Models
@using PocketMapApp.Data
@using Microsoft.EntityFrameworkCore
@inject TransactionService TransactionService
@inject DatabaseContext DatabaseContext
@inject AuthStateService AuthState

<div class="container mt-4">
    <h2>Transaction History</h2>

    <div class="row mb-4">
        <div class="col-md-3">
            <label>Type:</label>
            <select class="form-select" value="@selectedType" @onchange="@(e => FilterChanged("type", e.Value?.ToString()))">
                <option value="">All Types</option>
                <option value="Credit">Credit</option>
                <option value="Debit">Debit</option>
            </select>
        </div>
        <div class="col-md-3">
            <label>Date Range:</label>
            <select class="form-select" value="@dateRange" @onchange="@(e => FilterChanged("date", e.Value?.ToString()))">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
            </select>
        </div>
        <div class="col-md-3">
            <label>Tag:</label>
            <select class="form-select" value="@selectedTag" @onchange="@(e => FilterChanged("tag", e.Value?.ToString()))">
                <option value="">All Tags</option>
                @foreach (var tag in availableTags)
                {
                    <option value="@tag">@tag</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <label>Sort By:</label>
            <select class="form-select" value="@sortBy" @onchange="@(e => FilterChanged("sort", e.Value?.ToString()))">
                <option value="date_desc">Date (Newest First)</option>
                <option value="date_asc">Date (Oldest First)</option>
                <option value="amount_desc">Amount (Highest First)</option>
                <option value="amount_asc">Amount (Lowest First)</option>
            </select>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Title</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Tags</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                @if (filteredTransactions.Any())
                {
                    @foreach (var transaction in filteredTransactions)
                    {
                        <tr class="@(transaction.Type == TransactionType.Credit ? "table-success" : "table-danger")">
                            <td>@transaction.Date.ToShortDateString()</td>
                            <td>@transaction.Title</td>
                            <td>@transaction.Type</td>
                            <td>@transaction.Amount @AuthState.CurrentUser?.PreferredCurrency</td>
                            <td>
                                @foreach (var tag in transaction.Tags)
                                {
                                    <span class="badge bg-secondary me-1">@tag</span>
                                }
                            </td>
                            <td>@transaction.Notes</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center">No transactions found matching the selected filters.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private List<Transaction> allTransactions = new();
    private List<Transaction> filteredTransactions = new();
    private List<string> availableTags = new();
    private string selectedType = "";
    private string dateRange = "month";
    private string selectedTag = "";
    private string sortBy = "date_desc";

    protected override async Task OnInitializedAsync()
    {
        await LoadTransactions();
        ExtractAvailableTags();
        ApplyFilters();
    }

    private async Task LoadTransactions()
    {
        if (AuthState.CurrentUser != null)
        {
            allTransactions = await DatabaseContext.Transactions
                .Where(t => t.UserId == AuthState.CurrentUser.Id)
                .OrderByDescending(t => t.Date)
                .ToListAsync();
        }
    }

    private void ExtractAvailableTags()
    {
        availableTags = allTransactions
            .SelectMany(t => t.Tags)
            .Distinct()
            .OrderBy(t => t)
            .ToList();
    }

    private void FilterChanged(string filterType, string value)
    {
        if (value == null) return;

        switch (filterType)
        {
            case "type":
                selectedType = value;
                break;
            case "date":
                dateRange = value;
                break;
            case "tag":
                selectedTag = value;
                break;
            case "sort":
                sortBy = value;
                break;
        }

        ApplyFilters();
        StateHasChanged();
    }

    private void ApplyFilters()
    {
        var query = allTransactions.AsQueryable();

        // Type filter
        if (!string.IsNullOrEmpty(selectedType))
        {
            var type = Enum.Parse<TransactionType>(selectedType);
            query = query.Where(t => t.Type == type);
        }

        // Date filter
        var today = DateTime.Today;
        query = dateRange switch
        {
            "today" => query.Where(t => t.Date.Date == today),
            "week" => query.Where(t => t.Date.Date >= today.AddDays(-(int)today.DayOfWeek).Date),  // Start of current week (Sunday)
            "month" => query.Where(t => t.Date.Date >= new DateTime(today.Year, today.Month, 1)),  // Start of current month
            "year" => query.Where(t => t.Date.Date >= new DateTime(today.Year, 1, 1)),  // Start of current year
            _ => query
        };

        // Tag filter
        if (!string.IsNullOrEmpty(selectedTag))
        {
            query = query.Where(t => t.Tags.Contains(selectedTag));
        }

        // Sort
        query = sortBy switch
        {
            "date_asc" => query.OrderBy(t => t.Date),
            "date_desc" => query.OrderByDescending(t => t.Date),
            "amount_asc" => query.OrderBy(t => t.Amount),
            "amount_desc" => query.OrderByDescending(t => t.Amount),
            _ => query.OrderByDescending(t => t.Date)
        };

        filteredTransactions = query.ToList();
    }
}