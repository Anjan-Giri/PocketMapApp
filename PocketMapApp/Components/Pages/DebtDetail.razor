@page "/debtDetail"
@using PocketMapApp.Services
@using PocketMapApp.Models
@using PocketMapApp.Data
@using Microsoft.EntityFrameworkCore
@inject DebtService DebtService
@inject DatabaseContext DatabaseContext
@inject AuthStateService AuthState
@inject NavigationManager NavigationManager

<div class="container mt-4">
    <h2 class="mb-3">Debt Details</h2>

    <!-- search and filters -->
    <div class="row mb-4">
        <div class="col-md-3">
            <label>Search:</label>
            <input type="text" class="form-control" placeholder="Search by source..."
                   @bind-value="searchText" @bind-value:event="oninput" @onchange="ApplyFilters" />
        </div>
        <div class="col-md-2">
            <label>Status:</label>
            <select class="form-select" @bind="selectedStatus" @bind:after="ApplyFilters">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="cleared">Cleared</option>
            </select>
        </div>
        <div class="col-md-4">
            <label>Due Date Range:</label>
            <select class="form-select" @bind="dateRange" @bind:after="ApplyFilters">
                <option value="all">All Time</option>
                <option value="overdue">Overdue</option>
                <option value="today">Due Today</option>
                <option value="thisWeek">Due This Week</option>
                <option value="thisMonth">Due This Month</option>
                <option value="nextMonth">Due Next Month</option>
            </select>
        </div>
        <div class="col-md-3">
            <label>Sort By:</label>
            <select class="form-select" @bind="sortBy" @bind:after="ApplyFilters">
                <option value="dueDate_asc">Due Date (Earliest First)</option>
                <option value="dueDate_desc">Due Date (Farthest First)</option>
                <option value="amount_desc">Amount (Highest First)</option>
                <option value="amount_asc">Amount (Lowest First)</option>
            </select>
        </div>
    </div>

    <!-- debt details table -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Source</th>
                    <th>Amount</th>
                    <th>Due Date</th>
                    <th>Created Date</th>
                    <th>Status</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var debt in filteredDebts)
                {
                    <tr class="@GetRowClass(debt)">
                        <td>@debt.Source</td>
                        <td>@debt.Amount @AuthState.CurrentUser?.PreferredCurrency</td>
                        <td>
                            @debt.DueDate.ToShortDateString()
                            @if (IsOverdue(debt))
                            {
                                <span class="badge bg-danger ms-2">Overdue</span> //red background for overdue debts
                            }
                        </td>
                        <td>@debt.CreatedDate.ToShortDateString()</td>
                        <td>
                            <!-- green background for cleared debts and tellow for pending ones-->
                            <span class="badge @(debt.IsCleared ? "bg-success" : "bg-warning")"> 
                                @(debt.IsCleared ? "Cleared" : "Pending")
                            </span>
                        </td>
                        <td>@debt.Notes</td>
                        <td>
                            @if (!debt.IsCleared)
                            {
                                <button class="btn btn-success btn-sm" @onclick="() => ClearDebt(debt.Id)">
                                    Clear Debt
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3">@errorMessage</div>
    }
</div>

@code {
    private List<Debt> allDebts = new(); //stores debts of the user
    private List<Debt> filteredDebts = new(); //filtered debts

    //variables for values selected in filter
    private string selectedStatus = "";
    private string dateRange = "all";
    private string sortBy = "dueDate_asc";
    private string errorMessage = "";

    //search input
    private string searchText = "";

    protected override async Task OnInitializedAsync()
    {
        //calling the methods
        await LoadDebts();
        ApplyFilters();
    }

    //method for loading debts from the database
    private async Task LoadDebts()
    {
        allDebts = await DatabaseContext.Debts
            .Where(d => d.UserId == AuthState.CurrentUser.Id)
            .OrderBy(d => d.DueDate) //odering by due date
            .ToListAsync();
    }

    //method for checking the debts which are overdue
    private bool IsOverdue(Debt debt)
    {
        return !debt.IsCleared && debt.DueDate.Date < DateTime.Today; //debt is not cleated due date has passed
    }

    //data row css of background, success for cleared, danger for overdue and warning for pending
    private string GetRowClass(Debt debt)
    {
        if (debt.IsCleared)
            return "table-success";
        if (IsOverdue(debt))
            return "table-danger";
        return "table-warning";
    }

    //method to clear debt
    private async Task ClearDebt(int debtId)
    {
        var (success, error) = await DebtService.ClearDebt(debtId, AuthState.CurrentUser.Id); //calling cleardebt method

        //debt cleared successfully
        if (success)
        {
            //call methods
            await LoadDebts();
            ApplyFilters();
            errorMessage = "";
        }
        //failure
        else
        {
            errorMessage = error;
        }
    }

    //method for filters
    private void ApplyFilters()
    {
        var query = allDebts.AsQueryable();

        //search
        if (!string.IsNullOrWhiteSpace(searchText))
        {
            query = query.Where(d => d.Source.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                                   d.Notes.Contains(searchText, StringComparison.OrdinalIgnoreCase));
        }

        //status
        query = selectedStatus switch
        {
            "pending" => query.Where(d => !d.IsCleared),
            "cleared" => query.Where(d => d.IsCleared),
            _ => query
        };

        //date range
        var today = DateTime.Today;

        //using switch case for date filter
        switch (dateRange)
        {
            case "overdue":
                query = query.Where(d => !d.IsCleared && d.DueDate.Date < today);
                break;
            case "today":
                query = query.Where(d => d.DueDate.Date == today);
                break;
            case "thisWeek":
                var startOfWeek = today.AddDays(-(int)today.DayOfWeek);
                var endOfWeek = startOfWeek.AddDays(7);
                query = query.Where(d => d.DueDate.Date >= startOfWeek && d.DueDate.Date < endOfWeek);
                break;
            case "thisMonth":
                var startOfMonth = new DateTime(today.Year, today.Month, 1);
                var endOfMonth = startOfMonth.AddMonths(1);
                query = query.Where(d => d.DueDate.Date >= startOfMonth && d.DueDate.Date < endOfMonth);
                break;
            case "nextMonth":
                var startOfNextMonth = new DateTime(today.Year, today.Month, 1).AddMonths(1);
                var endOfNextMonth = startOfNextMonth.AddMonths(1);
                query = query.Where(d => d.DueDate.Date >= startOfNextMonth && d.DueDate.Date < endOfNextMonth);
                break;
        }

        //sorting
        query = sortBy switch
        {
            "dueDate_asc" => query.OrderBy(d => d.DueDate),
            "dueDate_desc" => query.OrderByDescending(d => d.DueDate),
            "amount_asc" => query.OrderBy(d => d.Amount),
            "amount_desc" => query.OrderByDescending(d => d.Amount),
            _ => query.OrderBy(d => d.DueDate)
        };

        filteredDebts = query.ToList(); //filtered debts list
    }

    protected override void OnParametersSet()
    {
        ApplyFilters();
    }
}